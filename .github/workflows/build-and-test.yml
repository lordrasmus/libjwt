name: LibJWT Build, Unit Tests, and Coverage

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths-ignore:
      - "doxygen/**"
      - ".github/**"
      - "images/**"
      - ".gitignore"
      - "*.md"
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - "doxygen/**"
      - ".github/**"
      - "images/**"
      - ".gitignore"
      - "*.md"

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        brew: gnutls openssl@3 jansson pkgconf cmake check curl bats-core jq

    - name: Build and Test
      uses: threeal/cmake-action@v2.1.0
      with:
        options:
          WITH_LIBCURL=YES
        build-args: |
          --
          all
          check

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        apt: gnutls-dev libssl-dev libjansson-dev pkg-config check lcov valgrind libcurl4-openssl-dev bats jq

    - name: Build, Test, and Coverage
      uses: threeal/cmake-action@v2.1.0
      with:
        options: |
          ENABLE_COVERAGE=YES
          WITH_LIBCURL=YES
        build-args: |
          --
          all
          check-code-coverage

    - uses: codecov/codecov-action@v5.1.2
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ${{github.workspace}}/build/check-code-coverage.info
        disable_search: true
        verbose: true

    - name: Memcheck
      working-directory: ${{github.workspace}}/build
      run: ctest -T memcheck

  build-linux-gnutls-asan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        apt: gnutls-dev libssl-dev libjansson-dev pkg-config check bats jq

    - name: Build and Test with GnuTLS (ASan+UBSan)
      uses: threeal/cmake-action@v2.1.0
      env:
        CFLAGS: -fsanitize=address,undefined -fno-omit-frame-pointer
        LDFLAGS: -fsanitize=address,undefined
      with:
        options: |
          CMAKE_BUILD_TYPE=Debug
        build-args: |
          --
          all
          check

  build-linux-mbedtls:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        apt: libmbedtls-dev libssl-dev libjansson-dev pkg-config check bats jq

    - name: Build and Test with MbedTLS (ASan+UBSan)
      uses: threeal/cmake-action@v2.1.0
      env:
        CFLAGS: -fsanitize=address,undefined -fno-omit-frame-pointer
        LDFLAGS: -fsanitize=address,undefined
      with:
        options: |
          WITH_MBEDTLS=YES
          CMAKE_BUILD_TYPE=Debug
        build-args: |
          --
          all
          check

  build-linux-mbedtls3:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        apt: libssl-dev libjansson-dev pkg-config check bats jq

    - name: Build MbedTLS 3.6 from source
      run: |
        git clone --depth 1 --branch v3.6.2 --recurse-submodules https://github.com/Mbed-TLS/mbedtls.git /tmp/mbedtls
        cmake -S /tmp/mbedtls -B /tmp/mbedtls/build \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
          -DENABLE_PROGRAMS=OFF \
          -DENABLE_TESTING=OFF \
          -DCMAKE_BUILD_TYPE=Release
        cmake --build /tmp/mbedtls/build -j$(nproc)
        sudo cmake --install /tmp/mbedtls/build

    - name: Build and Test with MbedTLS 3 (ASan+UBSan)
      uses: threeal/cmake-action@v2.1.0
      env:
        CFLAGS: -fsanitize=address,undefined -fno-omit-frame-pointer
        LDFLAGS: -fsanitize=address,undefined
        PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
      with:
        options: |
          WITH_MBEDTLS=YES
          CMAKE_BUILD_TYPE=Debug
        build-args: |
          --
          all
          check

  build-linux-json-c:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ConorMacBride/install-package@v1
      with:
        apt: gnutls-dev libssl-dev libjson-c-dev pkg-config check libcurl4-openssl-dev bats jq

    - name: Build and Test with json-c
      uses: threeal/cmake-action@v2.1.0
      with:
        options: |
          WITH_JSON_C=YES
          WITH_LIBCURL=YES
        build-args: |
          --
          all
          check
